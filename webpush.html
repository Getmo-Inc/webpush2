<html>
<head>
    <meta charset="utf-8">
    <link rel="manifest" href="/webpush-chrome-manifest.json">
    <script>
        var callback = '', params = {}, apiEndPoint = ((self.location.href+'').indexOf('local.getmo.') === -1) ? 'https://api.getmo.com.br' : 'https://local.getmo.api';
        function setParams(newParams) {
            if (typeof(newParams) === 'object'){
                try {
                    var lsParams = JSON.parse(localStorage.getItem('smartpush_params'));
                    for(var key in lsParams) {
                        if(lsParams.hasOwnProperty(key)){
                            params[key] = lsParams[key];
                        }
                    }
                } catch (e) {}
                for(var key in newParams) {
                    if(newParams.hasOwnProperty(key)){
                        params[key] = newParams[key];
                    }
                }
                localStorage.setItem('smartpush_params', JSON.stringify(params));
            }
        }
        function getParam(name) {
            if (params[name]) {
                return params[name];
            } else {
                try {
                    var lsParams = JSON.parse(localStorage.getItem('smartpush_params'));
                    if (lsParams[name]) {
                        params[name] = lsParams[name];
                        return lsParams[name];
                    } else {
                        return null;
                    }
                } catch(e) {
                    return null;
                }
            }
        }
        function sendMessageToServiceWorker(message){
            return new Promise(function(resolve, reject) {
                var messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = function(event) {
                    if (event.data.error) {
                        reject(event.data.error);
                    } else {
                        resolve(event.data);
                    }
                };
                navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);
            });
        }
        function sendMessageToParent(data) {
            if (window && window.parent && 'postMessage' in window.parent) {
                data.source = 'smartpush.webpush.iframe';
                if (parent !== window) {
                    parent.postMessage(data, '*');
                } else {
                    if (callback) {
                        window.location.href = callback;
                    }
                }
            }
        }
        function processMessageFromParent(e) {

            if (e.data && typeof(e.data) === 'object' && e.data.eventId) {

                var eventId = e.data.eventId;

                if (e.data.params && typeof(e.data.params) === 'object') {
                    setParams(e.data.params);
                }

                switch(e.data.action) {
                    case 'initializeServiceWorker':
                        if (getParam('platform') == 'CHROME' || getParam('platform') == 'FIREFOX') {
                            if (!getParam('setupEndPoint')) {
                                sendMessageToServiceWorker({test: true}).then(function(){
                                    if (getParam('hwid') && getParam('regid')) {
                                        sendMessageToParent({
                                            eventId: eventId,
                                            status: 'ready'
                                        });
                                    } else {
                                        initializeServiceWorker(false, eventId);
                                    }
                                }, function() {
                                    initializeServiceWorker(false, eventId);
                                });
                            } else {
                                if (getParam('hwid') && getParam('regid')) {
                                    sendMessageToParent({
                                        eventId: eventId,
                                        status: 'ready'
                                    });
                                } else {
                                    initializeServiceWorker(false, eventId);
                                }
                            }
                        } else if (getParam('platform') == 'SAFARI') {
                            sendMessageToParent({
                                eventId: eventId,
                                status: 'safari-has-setup'
                            });
                        }
                        break;
                    case 'subscribe':
                        subscribe(eventId);
                        break;
                    case 'unsubscribe':
                        unsubscribe(eventId);
                        break;
                    case 'checkSubscriptionStatus':
                        checkSubscriptionStatus(eventId);
                        break;
//                    case 'setParams':
//                        setParams(e.data.params);
//                        break;
                    case 'getLocalStorageParams':
                        sendMessageToParent({
                            eventId: eventId,
                            params: JSON.parse(localStorage.getItem('smartpush_params'))
                        });
                        break;
                    case 'template':
                        var template = e.data.template;
                        if (template) {
                            localStorage.setItem('smartpush_template', template);
                        }
                        sendMessageToParent({
                            eventId: eventId
                        });
                        break;
                    default:
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'pong'
                        });
                }
            }
        }

        function initializeServiceWorker(autoSubscribe, eventId) {
            navigator.serviceWorker.register('/webpush-service-worker.js', {scope: '/'}).then(function() {
                sendMessageToServiceWorker({test: true}).then(function(){
                    if (autoSubscribe && autoSubscribe === true && parent === window) {
                        subscribe();
                    } else {
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'ready'
                        });
                    }
                }, function(){
                    setTimeout(function(){
                        sendMessageToServiceWorker({test: true}).then(function(){
                            if (autoSubscribe && autoSubscribe === true && parent === window) {
                                subscribe();
                            } else {
                                sendMessageToParent({
                                    eventId: eventId,
                                    status: 'ready'
                                });
                            }
                        }, function() {
                            window.location.reload();
                        });
                    }, 200);
                });
            }, function(error) {
                if ((error + '').indexOf('Only secure origins are allowed') != -1) {
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'setup-ssl-error'
                    });
                } else if ((error + '').indexOf('The operation is insecure') != -1) {
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'setup-ssl-error'
                    });
                } else {
                    console.error('Error during registering service worker', error);
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'setup-error'
                    });
                }
            });
        }
        function getDataFromSubscription(subscription) {
            var data = {};
            if (getParam('platform') == 'CHROME') {
                if ('subscriptionId' in subscription) {
                    data.regid = subscription.subscriptionId;
                } else {
                    var split = subscription.endpoint.split('/');
                    data.regid = split[(split.length-1)];
                }
            } else if (getParam('platform') == 'FIREFOX') {
                var split = subscription.endpoint.split('/');
                data.regid = split[(split.length-1)];
                /*
                 // use when crypt libs are stable and without vulnerabilities!
                 data.p256dh = btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh'))));
                 */
            }
            return data;
        }
        function checkSubscriptionStatus(eventId) {
            switch (Notification.permission) {
                case 'denied':
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'status-denied-checked'
                    });
                    break;
                case 'default':
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'status-false-checked'
                    });
                    break;
                case 'granted':
                    var hwid = getParam('hwid'),
                        regid = getParam('regid'),
                        alias = getParam('alias');

                    if (hwid && regid) {
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'status-true-checked',
                            params: JSON.parse(localStorage.getItem('smartpush_params'))
                        });
                    } else {
                        sendMessageToServiceWorker({test: true}).then(function(){
                            navigator.serviceWorker.ready.then(function(registration) {
                                registration.pushManager.getSubscription().then(function(subscription) {
                                    if (!subscription) {
                                        sendMessageToParent({
                                            eventId: eventId,
                                            status: 'status-false-checked'
                                        });
                                        return;
                                    }
                                    if (hwid) {
                                        var data = getDataFromSubscription(subscription);
                                        if (data.regid) {
                                            setParams({regid: data.regid});
                                        }

                                        sendMessageToParent({
                                            eventId: eventId,
                                            status: 'status-true-checked',
                                            params: JSON.parse(localStorage.getItem('smartpush_params'))
                                        });
                                    } else {
                                        console.warn('You are not fully registered yet.');
                                        sendMessageToParent({
                                            eventId: eventId,
                                            status: 'status-false-checked'
                                        });
                                    }
                                }, function() {
                                    console.error('Cannot subscribe on GCM at the moment, please try again in 30 seconds.');
                                    sendMessageToParent({
                                        eventId: eventId,
                                        status: 'status-false-checked'
                                    });
                                });
                            }, function(){
                                console.error('Service Worker Cannot be ready');
                                sendMessageToParent({
                                    eventId: eventId,
                                    status: 'status-false-checked'
                                });
                            });
                        }, function(){
                            console.warn('Cannot access Service Worker');
                            sendMessageToParent({
                                eventId: eventId,
                                status: 'status-sm-unreachable'
                            });
                        });
                    }
                    break;
            }
        }
        function getSubscriptionData(data) {
            var hwid = getParam('hwid');
            if (!hwid) {
                hwid = 'null';
            }
            var params = {};
            if (getParam('platform') == 'CHROME') {
                params = {
                    appid: getParam('appid'),
                    uuid: hwid,
                    platform: 'CHROME',
                    regid: data.regid,
                    device: navigator.userAgent.match(/Chrom(e|ium|eframe)\/([0-9]+)\./i)[0],
                    manufacturer: navigator.vendor,
                    framework: navigator.platform ? navigator.platform : navigator.oscpu
                };
            } else if (getParam('platform') == 'FIREFOX') {
                params = {
                    appid: getParam('appid'),
                    uuid: hwid,
                    platform: 'FIREFOX',
                    regid: data.regid,
                    endpoint: data.endpoint,
                    p256dh: data.p256dh,
                    auth: data.auth,
                    device: navigator.userAgent.match(/Firefox\/([0-9]+)\./i)[0],
                    manufacturer: 'Mozilla',
                    framework: navigator.oscpu ? navigator.oscpu : navigator.platform
                };
            }

            var query = [];
            for(var key in params) {
                if(params.hasOwnProperty(key)){
                    query.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
                }
            }
            return query.join('&');
        }
        function subscribe(eventId) {
            Notification.requestPermission(function(permission) {
                if (permission == 'granted') {
                    navigator.serviceWorker.ready.then(function(registration) {
                        registration.pushManager.subscribe({userVisibleOnly: true}).then(function(subscription){
                            var data = getDataFromSubscription(subscription);
                            fetch(apiEndPoint + '/device', {
                                method: 'post',
                                headers: {
                                    'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
                                },
                                body: getSubscriptionData(data)
                            }).then(function(result){
                                if (result.status == 200) {
                                    result.json().then(function(json) {
                                        setParams({
                                            hwid: json.hwid,
                                            regid: data.regid,
                                            alias: json.alias
                                        });
                                        sendMessageToServiceWorker({
                                            devid: getParam('devid'),
                                            appid: getParam('appid'),
                                            hwid: getParam('hwid'),
                                            setupEndPoint: getParam('setupEndPoint')
                                        }).then(function(){
                                            sendMessageToParent({
                                                eventId: eventId,
                                                status: 'subscribed',
                                                params: JSON.parse(localStorage.getItem('smartpush_params'))
                                            });
                                        }, function(){
                                            console.error('Cannot send message to service worker!');
                                            window.location.reload(); // test failed cenario
                                        });
                                    }, function(){
                                        console.error('Api return is not a valid JSON.');
                                    });
                                } else {
                                    console.error('Subscrbe API fetch error!');
                                }
                            }, function(e) {
                                console.error('subscribe fetch error', e);
                            });
                        }, function (e) {
                            if ((e + '').indexOf('Registration failed') != -1) {
                                sendMessageToParent({
                                    eventId: eventId,
                                    status: 'registered-redirect'
                                });
                            } else {
                                sendMessageToParent({
                                    eventId: eventId,
                                    status: 'registered-error'
                                });
                            }
                            console.error('Unable to subscribe to push.', e);
                        });
                    });
                } else if (permission == 'denied') {
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'denied'
                    });
                } else {
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'default'
                    });
                }
            });
        }
        function unsubscribe(eventId) {
            navigator.serviceWorker.ready.then(function(registration) {
                registration.pushManager.getSubscription().then(function(subscription) {

                    if (!subscription) {
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'unsubscribed'
                        });
                        console.warn('No subscription found to unsubscribe');
                        return;
                    }

                    subscription.unsubscribe().then(function() {
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'unsubscribed'
                        });
                    }, function(e) {
                        console.error('Unsubscription error: ', e);
                        sendMessageToParent({
                            eventId: eventId,
                            status: 'unsubscribed-error'
                        });
                    });

                }, function(e) {
                    console.error('Error thrown while unsubscribing from push messaging.', e);
                    sendMessageToParent({
                        eventId: eventId,
                        status: 'unsubscribed-error'
                    });
                });
            });
        }
        function instantiateParams() {
            var getParams = {},
                    regex = /[?&]([^=#]+)=([^&#]*)/g,
                    match;

            while(match = regex.exec(window.location.href)) {
                getParams[match[1]] = match[2];
            }

            if (getParams.subscribe && getParams.subscribe == 'true' && getParams.callback) {
                callback = decodeURIComponent(getParams.callback);
                initializeServiceWorker(true);

                var template = localStorage.getItem('smartpush_template');
                if (template) {
                    var newDoc = document.open('text/html', 'replace');
                    newDoc.write(template);
                    newDoc.close();
                }
            }
        }
        if (window.addEventListener) {
            window.addEventListener('message', processMessageFromParent, false);
            window.addEventListener('load', instantiateParams);
        } else {
            window.attachEvent('onmessage', processMessageFromParent);
            window.attachEvent('onload', instantiateParams);
        }
    </script>
</head>
<body style="margin:0; overflow:hidden;">
<style scoped>
body { background: #F6F5F8; }
.bt { padding: 15px; border: 1px solid; border-radius: 3px; cursor: pointer; }
.bt.no{ background-color: #F6F5F8; border-color: #C7C7C7; color: #616161; }
.bt.yes{ background-color: #30849b; border-color: #287388; margin-left: 140px; color: #EFEFEF; }
.loading {

}
</style>
    <div id="content" style="font-family: 'Open Sans', sans-serif; width: 400px; margin: 30px auto; text-align: center">
        <div style="color: rgba(0,0,0,.7)">
            <h1 id="content-title" style="font-size: 20px; margin-bottom: 5px;">{{ titulo }}</h1>
            <h2 style="font-size: 18px; margin-top: 5px; margin-bottom: 35px;">deseja enviar notificações para você!</h2>
        </div>
        <div style="width: 360px; height: 80px; margin: 0 auto; overflow: hidden; background: url(https://cdn.getmo.com.br/images/notification-mockup.jpg); box-shadow: 0px 0px 4px #666;">
            <div id="image-container" style="margin-right: 15px; width: 80px; height: 80px; float: left">
                <!--<img width="80" height="80" src="http://imguol.com/c/noticias/72/2015/11/16/o-mes-de-novembro-chegou-e-o-uol-selecionou-alguns-papeis-de-parede-com-calendario-para-voce-mudar-o-visual-da-sua-area-de-trabalho-para-colocar-o-da-imagem-acima-em-seu-desktop-clique-no-botao-mais-1447707774255_80x80.jpg" alt="">-->
            </div>
            <div style="float: left; text-align: left; margin-top: 10px; position: relative; width: 245px; height: 70px">
                <div style="font-size: 16px; white-space: nowrap;">Título da Notificação</div>
                <div style="font-size: 12px; white-space: nowrap; position: absolute; top: 22px">Exemplo de texto da Notificação</div>
                <div style="color: #aaa; font-size: 13px; position: absolute; bottom: 5px">webpush.imobiliariaducati.com.br</div>
            </div>
        </div>
        <p style="font-size: 10px; color: #BBB;">(você pode cancelar a qualque hora)</p>
        <hr style="margin-top: 30px">
        <div style="margin: 15px 0">
            <button onclick="window.close()" id="no-bt" class="bt no">Não, Obrigado</button>
            <button onclick="subscribe()" id="yes-bt" class="bt yes">CONTINUAR</button>
        </div>
        <a href="http://www.getmo.com.br" target="_blank">
            <img width="90" height="20" src="https://cdn.getmo.com.br/images/logo-getmo.png" alt="Getmo Web Push">
        </a>
    </div>
<script>

</script>
</body>
</html>